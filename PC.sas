OPTIONS LS=80 NODATE;
TITLE 'PRINCIPAL COMPONENTS REGRESSION';

DATA HOSPITAL;
INPUT X1 X2 X3 X4 X5 Y;
CARDS;
  15.57  2463   472.92   18.0  4.45   566.52
  44.02  2048  1339.75    9.5  6.92   696.82
  20.42  3940   620.25   12.8  4.28  1033.15
  18.74  6505   568.33   36.7  3.90  1603.62
  49.20  5723  1497.60   35.7  5.50  1611.37
  44.92 11520  1365.83   24.0  4.60  1613.27
  55.48  5779  1687.00   43.3  5.62  1854.17
  59.28  5969  1639.92   46.7  5.15  2160.55
  94.39  8461  2872.33   78.7  6.18  2305.58
 128.02 20106  3655.08  180.5  6.15  3503.93
  96.00 13313  2912.00   60.9  5.88  3571.89
 131.42 10771  3921.00  103.7  4.88  3741.40
 127.21 15543  3865.67  126.8  5.50  4026.52
 252.90 36194  7684.10  157.7  7.00 10343.81
 409.20 34703 12446.33  169.4 10.78 11732.17
 463.70 39204 14098.40  331.4  7.05 15414.94
 510.22 86533 15524.00  371.6  6.35 18854.45
;

*  MACRO VARLIST CONTAINS THE NAMES OF THE REGRESSOR VARIABLES;
*  MACRO DEPVAR CONTAINS THE NAME OF THE DEPENDENT VARIABLE ;
*  MACRO DATASET CONTAINS THE NAME OF THE DATA SET CONTAINING THESE
   VARIABLES;

MACRO VARLIST  X1 X2 X3 X4 X5 %
MACRO DEPVAR  Y %
MACRO DATASET HOSPITAL %

* THE FOLLOWING MACRO DOES PRINCIPAL COMPONENTS REGRESSION;

MACRO PC

PROC IML;  USE DATASET;
READ ALL INTO X(|COLNAME=XNAMES|) VAR {VARLIST};
READ ALL INTO Y(|COLNAME=YNAME|) VAR {DEPVAR};
VARNAMES=XNAMES||YNAME;
* XY IS THE COMPLETE DATASET;
XY=X||Y;  P=NCOL(X); * P IS THE NUMBER OF MODEL VARIABLES;
P1=P+1;PP=5;PP=PP||P;
*PP IS THE MAXIMUM NUMBER OF PRINCIPAL COMPONENTS THAT CAN BE REMOVED;
N=NROW(XY);* N IS THE NUMBER OF OBSERVATIONS IN THE DATASET USED;
MEAN=XY(|:,|);XY=XY-REPEAT(MEAN,N,1);
* XY HAS NOW BEEN CORRECTED FOR THE  MEAN;
SS=SQRT(XY(|##,|));
* SS CONTAINS THE CORRECTED SUMS OF SQUARES OF EACH VARIABLE;
W=Y;* W IS THE Y VECTOR NOT CORRECTED FOR THE MEAN;
XY=XY/(J(N,1)*SS); Y=XY(|*,P1|);* Y IS NOW THE STANDARDIZED Y;
X=XY(|*,1:P|);* X IS THE STANDARDIZED X MATRIX;
XPX=X`*X;* XPX IS IN THE FORM OF A CORRELATION MATRIX;
CALL EIGEN(E,M,XPX); Z=X*M;
PRINT 'XPX IS THE CORRELATION MATRIX' XPX (|COLNAME=XNAMES|);
PRINT  'E IS THE VECTOR OF EIGENVALUES' E;
* M IS THE MATRIX OF COLUMNS OF EIGENVECTORS;
PRINT 'Z IS A MATRIX OF PRINCIPAL COMPONENTS ON THE COLUMNS' Z;
* TOP IS THE MINIMUM OF 5 OR P, THE NUMBER OF ORIGINAL VARIABLES;
* THE FOLLOWING DO LOOP DOES PRINCIPAL COMPONENTS REGRESSION;
I=0; TOP=MIN(PP); START PCPART;
LOOP:  IF I=TOP THEN GO TO LAST;PI=P-I; ZV=J(PI,1,0); ZZZ=J(N,1);
Z=Z(|*,1:PI|); ZPZ=Z`*Z; ZPY=Z`*W;ZIZ=INV(ZPZ);C=ZIZ*ZPY;
ZS=Z`;DO IR=1 TO N;ZV(|,1|)=ZS(|,IR|);ZT=ZV`;ZZZ(|IR,1|)=ZT*ZIZ*ZV;
ZZZ(|IR,1|)=1-ZZZ(|IR,1|)-1/N;END;
* YHAT IS THE PREDICTED Y FROM THE PRINCIPAL COMPONENTS REGRESSION;
* YDIFF IS A VECTOR OF THE RESPONSE VARIABLE MINUS IT'S MEAN;
* TOTAL IS THE CORRECTED TOTAL SUMS OF SQUARES;
YHAT=Z*C+MEAN(|1,P1|); YDIFF=(W-MEAN(|1,P1|));
TOTAL=SUM(YDIFF#YDIFF);
* R IS A VECTOR OF ORDINARY RESIDUALS;
* PR IS A VECTOR OF PRESS RESIDUALS;
R=W-YHAT;PR=R/ZZZ;RR=R#R;SSE=SUM(RR);MSE=SSE/(N-P1+I);
IF I=0 THEN SIGMA=MSE; CP=(1+PI)+(MSE-SIGMA)#(N-PI-1)/SIGMA;
PRINT  'I IS THE NUMBER OF PRINCIPAL COMPONENTS DROPPED' I;
PRINT
'C IS THE VECTOR OF REGRESSION COEFFICIENTS OF THE PRINCIPAL COMPONENT' C;
PRINT  'SSE IS THE ERROR SUM OF SQUARES' SSE;
PRINT 'MSE IS THE MEAN SQUARE ERROR' MSE;
PRINT 'CP IS THE CP STATISTIC' CP;
* SE IS A VECTOR OF STANDARD ERRORS OF PREDICTION;
* RSQUARE IS THE COEFFICIENT OF DETERMINATION;
SE=SQRT(MSE*(1-ZZZ));RSQUARE=(TOTAL-SSE)/TOTAL;
NAMES={'Y'  'OLS RES' 'PRESSRES' 'STD ERR'};
MAT=W||R||PR||SE; PR=PR##2;  PRESS=SUM(PR);
PRINT MAT (|COLNAME=NAMES|);PRINT PRESS RSQUARE;
B=M(|*,1:PI|)*C(|1:PI,1|); BNV=B/SS`(|1:P,1|);
PRINT BNV ;
INTERCPT=MEAN(|1,P1|); I=I+1;
INTERCPT=INTERCPT-BNV`*MEAN`(|1:P,1|);
PRINT 'BNV IS THE VECTOR OF REGRESSION COEFFICIENTS IN THE NATURAL VARIABLES';
PRINT BNV INTERCPT;
GO TO LOOP; LAST:
FINISH; RUN PCPART;
%

PC;

quit;
