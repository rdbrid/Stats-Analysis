OPTIONS LS=80 NODATE;
TITLE 'APPROXIMATE PRESS, SSE, MSE, VIF, COEFFICIENTS';

DATA HOSPITAL;
INPUT X1 X2 X3 X4 X5 Y;
CARDS;
  15.57  2463   472.92   18.0  4.45   566.52
  44.02  2048  1339.75    9.5  6.92   696.82
  20.42  3940   620.25   12.8  4.28  1033.15
  18.74  6505   568.33   36.7  3.90  1603.62
  49.20  5723  1497.60   35.7  5.50  1611.37
  44.92 11520  1365.83   24.0  4.60  1613.27
  55.48  5779  1687.00   43.3  5.62  1854.17
  59.28  5969  1639.92   46.7  5.15  2160.55
  94.39  8461  2872.33   78.7  6.18  2305.58
 128.02 20106  3655.08  180.5  6.15  3503.93
  96.00 13313  2912.00   60.9  5.88  3571.89
 131.42 10771  3921.00  103.7  4.88  3741.40
 127.21 15543  3865.67  126.8  5.50  4026.52
 252.90 36194  7684.10  157.7  7.00 10343.81
 409.20 34703 12446.33  169.4 10.78 11732.17
 463.70 39204 14098.40  331.4  7.05 15414.94
 510.22 86533 15524.00  371.6  6.35 18854.45
;

* MACRO VARLIST CONTAINS THE NAMES THE REGRESSOR VARIABLES;
* MACRO DEPVAR CONTAINS THE NAME OF THE DEPENDENT VARIABLE;
* MACRO DATASET CONTAINS THE NAME OF THE DATA SET CONTAINING THESE
  VARIABLES;
* MACRO AMT IS THE DESIRED INCREMENT ON k FOR RIDGE PRESS;

MACRO VARLIST X1 X2 X3 X4 X5  %
MACRO DEPVAR Y %
MACRO DATASET HOSPITAL  %
MACRO AMT .01  %

MACRO RPALL

* THIS MACRO COMPUTES APPROXIMATE PRESS STATISTICS FOR RIDGE REGRESSION
  ESTIMATORS USING A GRID ON THE K PARAMETER WHICH CAN BE CONTROLLED;

PROC IML;
* CALCULATION OF RIDGE ESTIMATORS;
START RIDGE;DO L=1 TO TOP;
PR(|L,2|)=INC;     KK=INC#I(NV);
XPX=(XX`*XX)+KK;   XIX=INV(XPX);
B=XIX*Z;           XS=XX`;
* PREPARATION FOR OBTAINING PRESS RESIDUALS;
DO IR=1 TO N;
XV(|,1|)=XS(|,IR|);  XT=XV`;             XXX(|IR,1|)=XT*XIX*XV;
XXX(|IR,1|)=1-XXX(|IR,1|)-1/N; END;
* XXX CONTAINS A VECTOR OF (1-HAT DIAGONAL);
* THE REGRESSION COEFFICIENTS ARE UNSTANDARDIZED AND CALLED TB;
*S=1./DIAG(STD);*T=VECDIAG(S);       TB=B/STD;  TBB=TB;
BO=TB`*MEAN`;     INTERCPT=YBAR-BO;  TB=INTERCPT//TB;
* PRR=PRESS RESIDUALS AND PSS=THE PRESS STATISTIC;
R=Y-X*TB;          PRR=R/XXX;         PSS=PRR#PRR;
PSS=PSS(|+,|);PR(|L,1|)=PSS;
A=VECDIAG(XX*XIX*XX`);                 A=A(|+,|);       PR(|L,3|)=A;
* SELECTION OF THE SMALLEST PRESS AND ASSOCIATED VARIABLES;
* ESS=ERROR SUMS OF SQUARES; * RESID=VECTOR OF RESIDUALS;
* BPRESS=THE SMALLEST PRESS; * PRESID=PRESS RESIDUALS;
* ESS=ERROR SUMS OF SQUARES; * BMSE=MEAN SQUARE ERROR;
* B=REGRESSION COEFFICIENTS; * VARCOV=VARIANCE-COVARIANCE MATRIX;
* VIF=VARIANCE INFLATION FACTOR;
* SE=STANDARD ERROR OF THE REGRESSION COEFFICIENT;
* TV=T-VALUE FOR TESTING H0:B=0; * P IS THE VALUE OF THAT TEST;
*IF PSS<BPRESS THEN DO; DO;
ESS=R#R;           ESS=ESS(|+,|);      K=INC;
BPRESS=PSS;        RESID=R;            PRESID=PRR;
BESS=ESS;          BMSE=ESS/(N-P1);   BB=B;
VARCOV=XIX*(XX`*XX)*XIX;               VIF=VECDIAG(VARCOV);
SE=(SQRT(BMSE#VIF));                   TV=B/SE;
P=(1-PROBT(ABS(TV),(N-P1)))*2;         END;
JKL=NV+4;          II=4:JKL;           PR(|L,II|)=TB`;
* K IS THE RIDGE PARAMETER; *BPRESS IS THE PRESS FOR A GIVEN K;
* BESS IS THE ERROR SUM OF SQUARES FOR A GIVEN K;
* BMSE IS THE ERROR MEAN SQUARE FOR A GIVEN K;
ANS=K||BPRESS||BESS||BMSE||A;
NAMES={'K' 'PRESS' 'ESS' 'MSE' 'A'};
PRINT ANS (|COLNAME=NAMES|);
RESULTS=RESID||PRESID;
NAMES= {'RESID' 'PRESID'};   *           PRINT RESULTS(|COLNAME=NAMES|);
ANS=TBB||P||VIF;                        NAMES={'TB' 'P VALUE' 'VIF'};
* TV IS A VECTOR OF THE UNSTANDARDIZED REGRESSION COEFFICIENTS;
* P IS THE P VALUE FOR TESTING THE HYPOTHESIS THAT THE COEFFICIENT IS
ZERO;
* VIF IS THE VARIANCE INFLATION FACTOR FOR THE COEFFICIENT;
PRINT ANS (|COLNAME=NAMES ROWNAME=VARNAMES|);
INC=INC+ADD;
END;   FINISH;
USE DATASET;READ ALL INTO X(|COLNAME=XNAMES|) VAR { VARLIST};
USE DATASET;READ ALL INTO Y(|COLNAME=YNAME|) VAR { DEPVAR };
* XY IS THE COMPLETE DATA SET;
VARNAMES=XNAMES||YNAME;                XY=X||Y;
* N IS THE NUMBER OF OBSERVATIONS IN THE DATA SET;
* NV IS THE NUMBER OF REGRESSOR VARIABLES INCLUDING TRANSFORMATIONS;
N=NROW(X);         NV=NCOL(X);         P1=NV+1;            IP=1:NV;
* THE NEXT LINE INITIALIZES THE MATRICES FOR FUTURE USE;
XI=J(N,1,1);       PR=J(25,NV+4,0);      XV=J(NV,1,0);
BPRESS=J(1,1,1E50);
*  THE X"S ARE CENTERED AND SCALED;
XXX=J(N,1);        XX=X;X=XI||X;       MEAN=XX(|+, |)/N;
YBAR=SUM(Y)/N;  XX=XX-J(N,1)*MEAN;  SS=XX(|##, |);
STD=SQRT(SS`);     XX=XX*DIAG(1/STD);
* Z CONTAINS X'*Y WITH STANDARDIZED X"S;
Z=XX`*Y;
* ADD IS THE INCREMENT ON K .....TOP IS THE NUMBER OF K;
INC=.0000;            ADD=AMT;              TOP=25;
RUN RIDGE;
*PR=PR(,1:P1+3);
NAMES={'PRESS' 'K' 'A'} ||COEF;  *       PRINT PR (| COLNAME=NAMES|);
* PRESS IS THE PRESS STATISTIC FOR A GIVEN K; * K IS THE RIDGE PARAMETER;
*A IS THE DF TRACE FOR A GIVEN K ;
CREATE KPLOT FROM PR(|COLNAME=NAMES|);  APPEND FROM PR;
RETURN;
PROC PLOT ;PLOT A*K='A';
* PLOTS OF ANY COEFFICIENT AND K MAY ALSO BE OBTAINED;
%
RPALL;

quit;
