OPTIONS LS=80 NODATE;

DATA FISH;
INPUT Y	X1 X2 X3 X4 X5 X6 $;
* Y is fish weight in pounds;
* X1 is water temperature in degrees Fahrenheit;
* X2 is size of the tank in gallons;
* X3 is the feeding amount in granules;
* X4 is the amount of dissolved oxygen in water mg/L;
* X5 is the length of the fish in inches;
* X6 is the presence (+) or absence (-) of the MuRF gene;
* GENE is an indicator variable for the presence of the MrRF gene;
* YT is the transformed response for the Box-Cox transformation;
GENE = 1;
IF X6 = "-" THEN GENE = 0;
YT = Y**(.50);
CARDS;
0.1	36	50	4	7		6.3		+
1.7	36	55	18	21		15.9	-
0.6	36	60	7	8		11.4	+
0.3	36	65	17	10		8.5		+
1	40	70	13	5		13.3	-
0.9	40	75	1	11.1	12.6	-
1.5	40	80	9	19.4	14.8	-
0.2	40	85	16	16.4	7.1		+
0.8	45	90	12	15		11.7	+
0.4	45	95	8	6		8.3		-
1.8	45	100	30	20		14.6	-
2.2	45	105	28	11		15		-
1	48	110	20	13		12.2	+
0.6	48	115	19	5.7		11.2	+
0.2	48	120	2	20		7.6		+
1.4	48	125	3	10.9	14.3	-
2	50	130	11	15.6	16		-
1	50	135	10	7.1		13.7	-
0.2	50	140	26	6.3		6.6		+
1.6	50	145	22	21.5	15.5	-
0.5	52	150	5	9.7		10.8	-
0.2	52	155	15	16.6	8.2		-
0.8	52	160	14	6.8		11		-
1.5	52	165	29	17.8	13.5	-
0.3	54	170	21	8.3		7.4		+
1	54	175	23	12		12.9	-
0.6	54	180	24	17.7	6.8		+
2	54	185	25	19.6	16.4	-
1.1	58	190	6	13.3	14.1	-
0.7	58	195	27	7.7		11.9	+
0.1	58	200	2	4.9		6.2		+
0.8	58	205	23	9		12.4	+
0.5	60	210	24	12.4	9.6		+
1.6	60	215	10	18		14.9	-
0.3	60	220	26	9.2		8.9		-
0.4	60	225	22	14		10.2	+
0.3	65	230	17	19.4	9.2		+
0.6	65	235	13	8.3		9.8		-
0.2	65	240	1	18.1	7.2		+
0.7	65	245	9	14.2	10.6	-
.   46  125 15  18.2    10.4    +
.   55  200 18  12.4    15.1    -
;

************************************************************************;
* SAS MACRO FOR BOX-COX TRANSFORMATION INCLUDING CONFIDENCE INTERVAL;

 * PUT THE DATA SET NAME BETWEEN  DATASET  AND  % .;
      MACRO DATASET FISH   %

 * PUT THE THE DEPENDENT VARIABLE BETWEEN  DEPVAR  AND  % .;
      MACRO DEPVAR  Y       %

 * PUT THE LIST OF INDEPENDENT VARIABLES BETWEEN  VARLIST  AND  % .;
      MACRO VARLIST X1 X2 X3 X4 X5 GENE   %

 * PUT THE NUMBER OF PARAMETERS (INCLUDING INTERCEPT) IN REGRESSION MODEL
    BETWEEN  P  AND  % .;
      MACRO P 7        %

 * PUT THE LOWER LIMIT OF LAMBDA (USUALLY -2) BETWEEN  LL  AND  % .;
      MACRO LL -2      %

 * PUT THE UPPER LIMIT OF LAMBDA (USUALLY  2) BETWEEN  UL  AND  % .;
      MACRO UL  2      %

 * PUT THE INCREMENT OF LAMBDA BETWEEN  I  AND  % .;
    * (FOR CONFIDENCE INTERVAL, .05 OR LESS IS RECOMMENDABLE.
       IN SOME CASES OF PRACTICE, .05 MAY BE OKAY.);
      MACRO I .03      %

MACRO BOXCOX

DATA A; SET DATASET; IF DEPVAR=. THEN DELETE;
                     TAG=1; N+1;
DATA B; SET A; BY TAG;
     LOGY=LOG(DEPVAR); SUMLOGY+LOGY;
     IF LAST.TAG THEN G=EXP(SUMLOGY/N);
     IF LAST.TAG;
DATA A; MERGE B(KEEP=N G TAG) A(DROP=N); BY TAG;
DATA A; SET A; LAMBDA=0; Z=LOG(DEPVAR)*G;
DATA C; SET A; DO LAMBDA=LL TO UL BY I; OUTPUT; END;
DATA C; SET C; IF ABS(LAMBDA)<.0001*I THEN DELETE;
     Z=(DEPVAR**LAMBDA-1)/(LAMBDA*G**(LAMBDA-1));
DATA A; SET A C;
PROC SORT; BY LAMBDA;
PROC REG OUTEST=A NOPRINT; BY LAMBDA;
     MODEL Z=VARLIST;
DATA B; SET B(KEEP=N);
     IF LL*UL>0 THEN DO LAMBDA=LL TO UL+I BY I; OUTPUT; END;
     ELSE DO LAMBDA=LL TO UL BY I; OUTPUT; END; DROP LAMBDA;
DATA A; MERGE A B;
     SSRESID=(N-P)*_RMSE_**2;
     MLOGL=-(N/2)*LOG(SSRESID/N);
TITLE 'PLOT FOR BOX-COX TRANSFORMATION';
PROC PLOT; LABEL MLOGL='MAX LOG LIKELIHOOD AT GIVEN LAMBDA';
     PLOT MLOGL*LAMBDA='+'/ HAXIS=LL TO UL;
RUN;
TITLE 'WHICH LAMBDA MAXIMIZES MAX_LOG_LIKEKIHOOD?';
PROC SORT; BY DESCENDING MLOGL;
DATA B; SET A(OBS=1); MAXMLOGL=MLOGL;
        LABEL MAXMLOGL='MAXIMUM OF MAX_LOG_LIKELIHOOD';
PROC PRINT LABEL; ID LAMBDA; VAR MAXMLOGL;
RUN;
TITLE1 'LIMITS OF CONFIDENCE INTERVALS SUCH THAT .90=<CONF. COEFF.<=.99';
TITLE3 ' IF YOU NEED AN APPROXIMATE .95 CONFIDENCE INTERVAL, CHOOSE TWO';
TITLE4 ' LAMBDA VALUES FOR LOWER AND UPPER LIMITS FROM BELOW  SUCH THAT';
TITLE6 ' THE INTERVAL CONTAINS THE LAMBDA MAXIMIZING MAX_LOG_LIKELIHOOD';
TITLE7 'AND';
TITLE8 ' THE CONF. COEFF. IS NEAR .95, OR,                             ';
TITLE9 '      IF YOU WANT TO BE CONSERVATIVE, MINUMUM AMONG THOSE>=.95.';
TITLE10'---------------------------------------------------------------';
DATA B; SET B(KEEP=MAXMLOGL);
     IF LL*UL>0 THEN DO LAMBDA=LL TO UL+I BY I; OUTPUT; END;
     ELSE DO LAMBDA=LL TO UL BY I; OUTPUT; END; DROP LAMBDA;
DATA A; MERGE A B; DIFF=MAXMLOGL-MLOGL;
                   D95=(PROBIT(.025))**2/2;
                   CONFCOEF=PROBCHI(2*DIFF,1);
                   P95TAILS=1-PROBCHI(2*D95,1);
                   IF .90=<CONFCOEF=<.99;
        LABEL LAMBDA='LAMBDA VALUES FOR CONF. INTERV. LIMITS'
                MLOGL='MAX_LOG_LIKELIHOOD AT GIVEN LAMBDA'
                DIFF='DIFF. BETW. MAX. MAX_LOG_L. & MAX_LOG_L.'
                 D95='(1/2) * CHI_SQUARE(.95, DF 1)'
            CONFCOEF='CONF. COEFF. OF INTERVAL W/ GIVEN DIFF.';
PROC PRINT LABEL; ID LAMBDA; VAR MLOGL DIFF CONFCOEF;
RUN;

%

BOXCOX
**********************************************************************;
TITLE "Aquaculture Data";
PROC REG DATA=FISH;
     MODEL YT = X1 X2 X3 X4 X5 GENE;

RUN;
QUIT;
